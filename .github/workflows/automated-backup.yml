name: Automated Database Backup

on:
  schedule:
    # Ejecutar todos los dÃ­as a las 2:00 AM UTC
    # Puedes modificar esto segÃºn necesites:
    # - Cada hora: '0 * * * *'
    # - Cada 6 horas: '0 */6 * * *'
    # - Semanal (domingos 2AM): '0 2 * * 0'
    # - Mensual (1ro de cada mes 2AM): '0 2 1 * *'
    - cron: '0 2 * * *'
  
  # Permite ejecuciÃ³n manual desde la pestaÃ±a Actions
  workflow_dispatch:

jobs:
  backup:
    name: Create Database Backup
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        
      - name: Deploy Backup Function
        run: |
          echo "ğŸ“¦ Ensuring backup function is deployed with --no-verify-jwt..."
          npx supabase functions deploy automated-backup --project-ref ${{ secrets.SUPABASE_PROJECT_REF }} --no-verify-jwt || echo "Deploy step completed"
      
      - name: Trigger Backup Function
        id: backup
        run: |
          echo "ğŸš€ Iniciando backup automÃ¡tico..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://${{ secrets.SUPABASE_PROJECT_REF }}.supabase.co/functions/v1/automated-backup?key=${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Status Code: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Backup completado exitosamente"
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Error en el backup"
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Notify Success
        if: steps.backup.outputs.result == 'success'
        run: |
          echo "âœ… Backup completado exitosamente"
          echo "ğŸ“… Fecha: $(date)"
          echo "ğŸ”§ ConfiguraciÃ³n: ${{ github.workflow }}"

      - name: Notify Failure
        if: failure()
        run: |
          echo "âŒ El backup ha fallado"
          echo "ğŸ“… Fecha: $(date)"
          echo "ğŸ” Revisar logs para mÃ¡s detalles"
          
          # AquÃ­ puedes agregar notificaciones adicionales:
          # - Enviar email
          # - Notificar en Slack
          # - Crear issue en GitHub
