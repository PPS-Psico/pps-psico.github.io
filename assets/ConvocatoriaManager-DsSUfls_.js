import{r,Q as W,U as q,bL as K,F as I,h as A,bw as re,n as P,bM as se,_,p as F,J as X,b2 as B,Z as ne,R as oe,V as H,aQ as le,ap as ee,j as e,b1 as de,aP as ie,N as ae,a5 as ce}from"./index-ZXlslG1z.js";import{C as Z}from"./CollapsibleSection-DXbQB952.js";const me=s=>{const v=String(s||"");return v?v.split(/ [-–] /)[0].trim():"Sin Nombre"},ue=({isTestingMode:s=!1,initialFilter:v="all"})=>{const[z,m]=r.useState([]),[O,u]=r.useState(new Map),[R,p]=r.useState("initial"),[E,c]=r.useState(null),[j,h]=r.useState(null),[L,i]=r.useState(new Set),[w,n]=r.useState(""),[l,S]=r.useState(v);r.useEffect(()=>{v&&S(v)},[v]);const t=r.useCallback(async()=>{p("loading"),c(null);try{if(s){const a=await W.getAll(q);m(a),p("loaded");return}const o=new Date,N=o.toISOString().split("T")[0],x={};l==="vencidas"?x.endDate=N:l==="proximas"&&(x.startDate=N);const{records:f,error:T}=await K(q,1,1e3,[],w,[I],{field:A,direction:"asc"},x),{records:D}=await K(re,1,1e3,["nombre","telefono"]);if(T)throw new Error(T.error);const C=new Map;D.forEach(a=>{a.nombre&&C.set(P(a.nombre),{id:String(a.id),phone:a.telefono||void 0})}),u(C);const k=f.map(se).filter(a=>{const d=a[_];if(d==="Archivado"||d==="No se Relanza")return!1;if(l==="vencidas"){const b=F(a[A]);return b&&b<o}if(l==="proximas"){const b=F(a[A]);return b&&b>=o}return!0});m(k),p("loaded")}catch(o){console.error("CRITICAL ERROR in useGestionConvocatorias:",o),h({message:`Error crítico al cargar datos: ${o.message}`,type:"error"}),c(o.message||"Error al cargar datos"),p("error")}},[s,l,w]);r.useEffect(()=>{t()},[t]);const M=r.useCallback(async(o,N)=>{i(x=>new Set(x).add(o));try{return s?(await W.update(q,o,N),m(x=>x.map(f=>f.id===o?{...f,...N}:f))):(await X.lanzamientos.update(o,N),t()),h({message:"Guardado correctamente.",type:"success"}),!0}catch{return h({message:"Error al guardar.",type:"error"}),!1}finally{i(x=>{const f=new Set(x);return f.delete(o),f})}},[t,s]),U=r.useCallback(async(o,N)=>{if(s)return!0;try{return await X.instituciones.update(o,{telefono:N}),h({message:"Teléfono actualizado.",type:"success"}),!0}catch{return h({message:"Error al actualizar teléfono.",type:"error"}),!1}},[s]),$=r.useMemo(()=>{const o=new Date;new Date().setDate(o.getDate()+7);const x=[],f=[],T=[],D=[],C=new Map;return z.forEach(g=>{const k=me(g[I]);C.has(k)||C.set(k,[]),C.get(k).push(g)}),C.forEach((g,k)=>{g.sort((y,G)=>{const te=new Date(y[A]||"1900-01-01").getTime();return new Date(G[A]||"1900-01-01").getTime()-te});const a=g.find(y=>P(y[_])==="relanzamiento confirmado"||y[B]&&new Date(y[B]).getFullYear()>=2026);if(a){x.push(a);return}const d=g.find(y=>{const G=P(y[_]);return G!=="archivado"&&G!=="no se relanza"})||g[0];if(!d)return;const b=P(d[_]);if(b==="archivado"||b==="no se relanza")return;const J=F(d[A]),Q=F(d[ne]);if(!J||!Q){D.push(d);return}const Y=Math.ceil((Q.getTime()-o.getTime())/(1e3*3600*24));if(Y<0)T.push({...d,daysSinceEnd:Math.abs(Y)});else{const y=Y<=7?"high":"normal";f.push({...d,daysLeft:Y,urgency:y})}}),{relanzamientosConfirmados:x,pendientesDeGestion:[],activasYPorFinalizar:f.sort((g,k)=>(g.daysLeft||999)-(k.daysLeft||999)),finalizadasParaReactivar:T.sort((g,k)=>(g.daysSinceEnd||0)-(k.daysSinceEnd||0)),activasIndefinidas:D}},[z]);return{institutionsMap:O,loadingState:R,error:E,toastInfo:j,setToastInfo:h,updatingIds:L,searchTerm:w,setSearchTerm:n,orientationFilter:"all",setOrientationFilter:()=>{},filterType:l,setFilterType:S,handleSave:M,handleUpdateInstitutionPhone:U,handleSync:async()=>{},handleLinkOrphans:async()=>{},filteredData:$}},xe=["Pendiente de Gestión","Relanzamiento Confirmado","Esperando Respuesta","No se Relanza","Archivado"],V=oe.memo(({pps:s,onSave:v,isUpdating:z,institution:m,onSavePhone:O,daysLeft:u,urgency:R})=>{const[p,E]=r.useState(!1),[c,j]=r.useState(s[_]||"Pendiente de Gestión"),[h,L]=r.useState(s[H]||""),[i,w]=r.useState(()=>{const a=s[B];if(a)return a;const d=s[A];if(d){const b=F(d);if(b&&b.getUTCFullYear()>=2026)return d}return""}),[n,l]=r.useState(!1),[S,t]=r.useState(!1),[M,U]=r.useState(""),$=le(s[ee]),o=r.useMemo(()=>{const a=s[_]||"Pendiente de Gestión",d=s[H]||"",b=s[B]||"";return c!==a||h!==d||(c==="Relanzamiento Confirmado"?i!==b:!1)},[c,h,i,s]),N=async a=>{if(a.stopPropagation(),!o)return;const d={[_]:c,[H]:h};c==="Relanzamiento Confirmado"&&(d[B]=i),l(!0),await v(s.id,d)?(setTimeout(()=>l(!1),2e3),E(!1)):l(!1)},x=a=>{if(a.stopPropagation(),!(m!=null&&m.phone))return;const b=(m.phone||"").replace(/[^0-9]/g,"");window.open(`https://wa.me/${b}`,"_blank","noopener,noreferrer")},f=async a=>{if(a.stopPropagation(),!m||!M.trim())return;await O(m.id,M.trim())&&(t(!1),U(""))},T=r.useMemo(()=>c==="Relanzamiento Confirmado"?"bg-emerald-100 text-emerald-800 border-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-300 dark:border-emerald-800":c==="No se Relanza"?"bg-rose-100 text-rose-800 border-rose-200 dark:bg-rose-900/30 dark:text-rose-300 dark:border-rose-800":c==="Esperando Respuesta"?"bg-amber-100 text-amber-800 border-amber-200 dark:bg-amber-900/30 dark:text-amber-300 dark:border-amber-800":"bg-slate-100 text-slate-600 border-slate-200 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700",[c]),D=()=>u===void 0?null:u>0&&u<=7?e.jsxs("span",{className:"text-[10px] font-bold text-rose-600 dark:text-rose-400 bg-rose-50 dark:bg-rose-900/20 px-2 py-0.5 rounded border border-rose-200 dark:border-rose-800 flex items-center gap-1 animate-pulse",children:[e.jsx("span",{className:"material-icons !text-[10px]",children:"timer"})," Finaliza en ",u," días"]}):u>7&&u<=30?e.jsxs("span",{className:"text-[10px] font-bold text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/20 px-2 py-0.5 rounded border border-amber-200 dark:border-amber-800 flex items-center gap-1",children:[e.jsx("span",{className:"material-icons !text-[10px]",children:"schedule"})," Vence en ",u," días"]}):u<=0?e.jsxs("span",{className:"text-[10px] font-bold text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded border border-slate-200 dark:border-slate-700 flex items-center gap-1",children:[e.jsx("span",{className:"material-icons !text-[10px]",children:"history"})," Finalizó hace"," ",Math.abs(u)," días"]}):null,C=()=>{if(!i)return null;const a=F(i);return a?a.getFullYear():i.length>15?i.substring(0,12)+"...":i},g=c==="Relanzamiento Confirmado"||i&&new Date(i).getFullYear()>=2026,k=p?"shadow-xl ring-1 ring-blue-500/20 border-blue-300 dark:border-blue-700":R==="high"?"shadow-sm hover:shadow-md border-l-4 border-l-rose-500 border-t border-r border-b border-rose-200 dark:border-rose-900 bg-rose-50/30 dark:bg-rose-900/10":`shadow-sm hover:shadow-md border-l-4 ${$.leftBorder} border-t border-r border-b border-slate-200 dark:border-slate-700`;return e.jsxs("div",{className:`relative bg-white dark:bg-gray-900 rounded-xl transition-all duration-300 overflow-hidden ${k}`,onClick:()=>!S&&E(!p),children:[e.jsxs("div",{className:"p-4 pl-5 cursor-pointer",children:[e.jsxs("div",{className:"flex justify-between items-start gap-3",children:[e.jsxs("div",{className:"flex-grow min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1 flex-wrap",children:[e.jsx("span",{className:`${$.tag} text-[10px] py-0.5 px-2 font-bold`,children:s[ee]}),g&&i&&e.jsxs("span",{className:"text-[10px] font-bold text-emerald-600 dark:text-emerald-400 flex items-center gap-1 bg-emerald-50 dark:bg-emerald-900/20 px-2 py-0.5 rounded-full border border-emerald-100 dark:border-emerald-800",children:[e.jsx("span",{className:"material-icons !text-[10px]",children:"event"}),C()]}),e.jsx(D,{})]}),e.jsx("h4",{className:"font-bold text-slate-800 dark:text-slate-100 leading-tight truncate pr-4",title:s[I],children:s[I]})]}),e.jsxs("div",{className:"flex-shrink-0 flex items-center gap-2",children:[m!=null&&m.phone?e.jsx("button",{onClick:x,className:"p-2 rounded-full bg-green-50 text-green-600 hover:bg-green-100 dark:bg-green-900/20 dark:text-green-400 transition-colors",title:"WhatsApp",children:e.jsx("span",{className:"material-icons !text-lg",children:"chat"})}):e.jsx("button",{onClick:a=>{a.stopPropagation(),t(!0)},className:"p-2 rounded-full text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors",title:"Agregar Teléfono",children:e.jsx("span",{className:"material-icons !text-lg",children:"add_call"})}),e.jsx("div",{className:`transform transition-transform duration-300 text-slate-400 ${p?"rotate-180":""}`,children:e.jsx("span",{className:"material-icons",children:"expand_more"})})]})]}),S&&e.jsxs("div",{className:"absolute top-3 right-12 z-20 flex items-center gap-1 bg-white dark:bg-slate-900 p-1 rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 animate-scale-in",onClick:a=>a.stopPropagation(),children:[e.jsx("input",{type:"tel",value:M,onChange:a=>U(a.target.value),className:"w-28 text-xs p-1.5 border-none bg-transparent focus:ring-0 outline-none text-slate-800 dark:text-white",placeholder:"Número...",autoFocus:!0}),e.jsx("button",{onClick:f,className:"p-1 text-emerald-500 hover:bg-emerald-50 rounded",children:e.jsx("span",{className:"material-icons !text-sm",children:"check"})}),e.jsx("button",{onClick:a=>{a.stopPropagation(),t(!1)},className:"p-1 text-rose-500 hover:bg-rose-50 rounded",children:e.jsx("span",{className:"material-icons !text-sm",children:"close"})})]})]}),e.jsx("div",{className:`grid transition-all duration-300 ease-in-out ${p?"grid-rows-[1fr] opacity-100 border-t border-slate-100 dark:border-slate-800":"grid-rows-[0fr] opacity-0"}`,children:e.jsx("div",{className:"overflow-hidden bg-slate-50/50 dark:bg-slate-800/20 cursor-default",onClick:a=>a.stopPropagation(),children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex gap-4 items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5 block",children:"Estado"}),e.jsx("select",{value:c,onChange:a=>j(a.target.value),className:`w-full text-sm font-semibold rounded-lg py-2.5 px-3 border outline-none focus:ring-2 focus:ring-blue-500/20 cursor-pointer transition-colors appearance-none ${T}`,children:xe.map(a=>e.jsx("option",{value:a,children:a},a))})]}),c!=="Relanzamiento Confirmado"&&c!=="No se Relanza"&&e.jsx("div",{className:"mt-6",children:e.jsx("button",{onClick:()=>{j("Relanzamiento Confirmado")},className:"text-xs font-bold text-emerald-600 hover:text-emerald-700 dark:text-emerald-400 underline decoration-dotted underline-offset-4",children:"Confirmar 2026"})})]}),g&&e.jsxs("div",{className:"animate-fade-in bg-emerald-50/50 dark:bg-emerald-900/10 p-3 rounded-lg border border-emerald-100 dark:border-emerald-800/50",children:[e.jsxs("label",{className:"text-xs font-bold text-emerald-600 dark:text-emerald-400 uppercase tracking-wider mb-1.5 flex items-center gap-1",children:[e.jsx("span",{className:"material-icons !text-sm",children:"event"}),"Fecha Estimada Incio 2026"]}),e.jsx("input",{type:"text",placeholder:"Ej: 15/03/2026...",value:i,onChange:a=>w(a.target.value),className:"w-full text-sm font-medium rounded-lg py-2 px-3 border border-emerald-300 dark:border-emerald-700 bg-white dark:bg-slate-800 focus:ring-2 focus:ring-emerald-500/50 outline-none text-slate-800 dark:text-slate-100"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5 flex items-center gap-2",children:[e.jsx("span",{className:"material-icons !text-xs",children:"edit_note"}),"Bitácora de Gestión"]}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{value:h,onChange:a=>L(a.target.value),rows:3,className:"w-full text-sm rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-3 pl-4 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none leading-relaxed",placeholder:"Escribe aquí los avances..."}),e.jsx("div",{className:"absolute left-0 top-3 bottom-3 w-1 bg-blue-400 rounded-r opacity-50"})]})]}),e.jsx("div",{className:"flex justify-end pt-2",children:e.jsxs("button",{onClick:N,disabled:z||!o||n,className:`flex items-center gap-2 py-2 px-6 rounded-lg text-sm font-bold shadow-sm transition-all transform active:scale-95
                                ${n?"bg-emerald-500 text-white cursor-default":o?"bg-blue-600 text-white hover:bg-blue-700 hover:shadow-md":"bg-slate-200 dark:bg-slate-700 text-slate-400 dark:text-slate-500 cursor-not-allowed"}
                            `,children:[z?e.jsx("div",{className:"w-4 h-4 border-2 border-white/50 border-t-white rounded-full animate-spin"}):e.jsx("span",{className:"material-icons !text-base",children:n?"check":"save"}),e.jsx("span",{children:n?"Guardado":"Guardar Cambios"})]})})]})})})]})}),fe=({forcedOrientations:s,isTestingMode:v=!1})=>{const[z,m]=de(),O=z.get("filter")||"all",{institutionsMap:u,loadingState:R,error:p,toastInfo:E,setToastInfo:c,updatingIds:j,searchTerm:h,setSearchTerm:L,handleSave:i,handleUpdateInstitutionPhone:w,filteredData:n,filterType:l,setFilterType:S}=ue({isTestingMode:v,initialFilter:O});return r.useEffect(()=>{m(l!=="all"?{filter:l}:{})},[l,m]),R==="loading"||R==="initial"?e.jsx("div",{className:"flex justify-center p-10",children:e.jsx(ie,{})}):p?e.jsx(ae,{icon:"error",title:"Error",message:p}):e.jsxs("div",{className:"animate-fade-in-up space-y-8",children:[E&&e.jsx(ce,{message:E.message,type:E.type,onClose:()=>c(null)}),e.jsx("div",{className:"p-4 bg-white dark:bg-[#0F172A] rounded-xl border border-slate-200 dark:border-white/5 shadow-sm sticky top-20 z-30 backdrop-blur-md bg-white/90 dark:bg-[#0F172A]/90",children:e.jsxs("div",{className:"flex flex-col xl:flex-row items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-4 w-full xl:w-auto",children:[e.jsxs("h2",{className:"text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2 whitespace-nowrap",children:[e.jsx("span",{className:"material-icons text-blue-600 dark:text-blue-400",children:"tune"}),"Panel de Gestión"]}),e.jsxs("div",{className:"flex items-center gap-1 bg-slate-100 dark:bg-black/40 p-1 rounded-lg border border-transparent dark:border-white/5",children:[e.jsx("button",{onClick:()=>S("all"),className:`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${l==="all"?"bg-white dark:bg-slate-700 text-blue-600 dark:text-blue-300 shadow-sm":"text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200"}`,children:"Todo"}),e.jsxs("button",{onClick:()=>S("vencidas"),className:`px-3 py-1.5 rounded-md text-xs font-bold transition-all flex items-center gap-1 ${l==="vencidas"?"bg-white dark:bg-rose-900/40 text-rose-600 dark:text-rose-300 shadow-sm border border-transparent dark:border-rose-800/50":"text-slate-500 hover:text-rose-500 dark:text-slate-400 dark:hover:text-rose-400"}`,children:[e.jsx("span",{className:"material-icons !text-xs",children:"priority_high"})," Vencidas"]}),e.jsxs("button",{onClick:()=>S("proximas"),className:`px-3 py-1.5 rounded-md text-xs font-bold transition-all flex items-center gap-1 ${l==="proximas"?"bg-white dark:bg-amber-900/40 text-amber-600 dark:text-amber-300 shadow-sm border border-transparent dark:border-amber-800/50":"text-slate-500 hover:text-amber-500 dark:text-slate-400 dark:hover:text-amber-400"}`,children:[e.jsx("span",{className:"material-icons !text-xs",children:"schedule"})," Próximas"]})]})]}),e.jsxs("div",{className:"relative w-full sm:w-80 group",children:[e.jsx("input",{id:"pps-filter",type:"text",value:h,onChange:t=>L(t.target.value),placeholder:"Filtrar por nombre de PPS...",className:"w-full pl-10 pr-4 py-2.5 border border-slate-300 dark:border-white/10 rounded-lg text-sm bg-slate-50 dark:bg-black/20 focus:border-blue-500 focus:bg-white dark:focus:bg-black/40 focus:ring-2 focus:ring-blue-500/20 outline-none transition-all shadow-sm text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500"}),e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 material-icons text-slate-400 dark:text-slate-500 group-focus-within:text-blue-500 dark:group-focus-within:text-blue-400 transition-colors",children:"search"})]})]})}),n.activasYPorFinalizar.length>0&&l==="all"&&e.jsx(Z,{title:"Activas y Por Finalizar",count:n.activasYPorFinalizar.length,icon:"notifications_active",iconBgColor:"bg-blue-100 dark:bg-blue-900/30",iconColor:"text-blue-600 dark:text-blue-400",borderColor:"border-blue-300 dark:border-blue-800",defaultOpen:!0,children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mt-4 items-start",children:n.activasYPorFinalizar.map(t=>e.jsx(V,{pps:t,onSave:i,isUpdating:j.has(t.id),cardType:"activas",institution:u.get(P(t[I]||"")),onSavePhone:w,daysLeft:t.daysLeft},t.id))})}),n.finalizadasParaReactivar.length>0&&l==="all"&&e.jsx(Z,{title:"Finalizadas - Requieren Gestión",count:n.finalizadasParaReactivar.length,icon:"restore_page",iconBgColor:"bg-amber-100 dark:bg-amber-900/30",iconColor:"text-amber-600 dark:text-amber-400",borderColor:"border-amber-300 dark:border-amber-800",defaultOpen:!0,children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mt-4 items-start",children:n.finalizadasParaReactivar.map(t=>e.jsx(V,{pps:t,onSave:i,isUpdating:j.has(t.id),cardType:"finalizadas",institution:u.get(P(t[I]||"")),onSavePhone:w,daysLeft:-(t.daysSinceEnd||0)},t.id))})}),n.relanzamientosConfirmados.length>0&&l==="all"&&e.jsx(Z,{title:"Relanzamientos Confirmados (Planificados)",count:n.relanzamientosConfirmados.length,icon:"flight_takeoff",iconBgColor:"bg-emerald-100 dark:bg-emerald-900/30",iconColor:"text-emerald-600 dark:text-emerald-400",borderColor:"border-emerald-300 dark:border-emerald-800",defaultOpen:!1,children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mt-4 items-start",children:n.relanzamientosConfirmados.map(t=>e.jsx(V,{pps:t,onSave:i,isUpdating:j.has(t.id),cardType:"relanzamientosConfirmados",institution:u.get(P(t[I]||"")),onSavePhone:w},t.id))})}),n.activasIndefinidas.length>0&&l==="all"&&e.jsx(Z,{title:"Gestión Manual / Indefinidas",count:n.activasIndefinidas.length,icon:"edit_calendar",iconBgColor:"bg-slate-100 dark:bg-slate-800",iconColor:"text-slate-600 dark:text-slate-400",borderColor:"border-slate-300 dark:border-slate-700",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mt-4 items-start",children:n.activasIndefinidas.map(t=>e.jsx(V,{pps:t,onSave:i,isUpdating:j.has(t.id),cardType:"indefinidas",institution:u.get(P(t[I]||"")),onSavePhone:w},t.id))})}),n.activasYPorFinalizar.length===0&&n.finalizadasParaReactivar.length===0&&n.relanzamientosConfirmados.length===0&&e.jsx(ae,{icon:"assignment_turned_in",title:"Todo al día",message:"No hay instituciones requiriendo atención inmediata."})]})};export{fe as C,ue as u};
