import{r as p,g as ee,O as ae,i as se,Q as y,cm as te,I as v,G as w,j as e,a5 as me,C as pe,aP as ue,N as xe,cn as be,co as q,bB as E,bp as G,a2 as z,c3 as H,bj as F,cp as J,a3 as R,cq as Y,b6 as M,cr as ge,ax as B,cd as Z,M as U,cc as re,cb as V,aD as le,aF as ne,ca as oe,F as I,h as $,be as W,U as ie,bM as de,bb as he,cs as fe,bH as Ne}from"./index-ZXlslG1z.js";import{A as Ae}from"./AdminSearch-DMlT1HSE.js";import{C as je}from"./ConfirmModal-DfSwa4qW.js";const X=["Baja Anticipada","Baja sobre la Fecha / Ausencia en Inicio","Abandono durante la PPS","Falta sin Aviso"],Ee=({isOpen:n,onClose:N,student:c,onSuccess:h,isTestingMode:A=!1})=>{const[i,f]=p.useState(X[0]),[r,u]=p.useState(""),[x,C]=p.useState(""),L=ee(),{data:S,isLoading:O}=ae({queryKey:["relevantPPSForModal",c.id,A],queryFn:async()=>{if(A)return(await y.getAll("lanzamientos_pps")).map(l=>({id:l.id,name:`${l[I]} (${U(l[$])})`}));const a=await E(z,[R,B],{[G]:c.legajo,[B]:["Seleccionado","Inscripto"]}),j=await E(F,[M,W],{[H]:c.legajo,[W]:"En curso"}),t=a.records.map(J),b=j.records.map(Y),g=new Set;return t.forEach(d=>{const l=d[R];(Array.isArray(l)?l:[l]).filter(Boolean).forEach(s=>g.add(s))}),b.forEach(d=>{const l=d[M];(Array.isArray(l)?l:[l]).filter(Boolean).forEach(s=>g.add(s))}),g.size===0?[]:(await E(ie,[I,$],{id:Array.from(g)})).records.map(de).map(d=>({id:d.id,name:`${d[I]} (${U(d[$])})`}))},enabled:n}),P=se({mutationFn:async a=>{if(A){console.log("TEST MODE: Applying penalty:",a),await y.create("penalizaciones",a);return}const j=await be(q,a);if(j.error){const b=typeof j.error.error=="string"?j.error.error:j.error.error.message;throw new Error(`Error al crear la penalización: ${b}`)}if(x&&["Baja Anticipada","Baja sobre la Fecha / Ausencia en Inicio","Abandono durante la PPS"].includes(i)){const b=x,[g,_]=await Promise.all([E(z,void 0,{[G]:c.legajo}),E(F,void 0,{[H]:c.legajo})]),d=g.records.map(J).find(m=>{const o=m[R];return(Array.isArray(o)?o:[o]).includes(b)}),l=_.records.map(Y).find(m=>{const o=m[M];return(Array.isArray(o)?o:[o]).includes(b)}),s=[];d&&s.push(ge(z,d.id,{[B]:"No Seleccionado"})),l&&s.push(te(F,l.id)),s.length>0&&await Promise.all(s)}},onSuccess:()=>{L.invalidateQueries({queryKey:["allPenalizedStudents"]}),h(),N()},onError:a=>{alert(`Error: ${a.message}`)}}),T=()=>{const a={[le]:c.id,[Z]:i,[re]:new Date().toISOString().split("T")[0],[V]:r,[ne]:10};x&&(a[oe]=x),P.mutate(a)};return n?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm",onClick:N,children:e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-lg",onClick:a=>a.stopPropagation(),children:[e.jsx("div",{className:"p-6 border-b border-slate-200 dark:border-slate-700",children:e.jsxs("h3",{className:"text-lg font-bold",children:["Aplicar Penalización a ",e.jsx("span",{className:"text-blue-600",children:c.nombre})]})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"pps-select-modal",className:"text-sm font-medium text-slate-600 dark:text-slate-300 mb-1 block",children:"PPS Afectada (Opcional)"}),O?e.jsx("p",{children:"Cargando PPS..."}):e.jsxs("select",{id:"pps-select-modal",value:x,onChange:a=>C(a.target.value),className:"w-full text-sm rounded-lg border border-slate-300 dark:border-slate-600 p-2.5 bg-white dark:bg-slate-700",children:[e.jsx("option",{value:"",children:"Seleccionar una PPS..."}),S==null?void 0:S.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"penalty-type-modal",className:"text-sm font-medium text-slate-600 dark:text-slate-300 mb-1 block",children:"Tipo de Incumplimiento"}),e.jsx("select",{id:"penalty-type-modal",value:i,onChange:a=>f(a.target.value),className:"w-full text-sm rounded-lg border border-slate-300 dark:border-slate-600 p-2.5 bg-white dark:bg-slate-700",children:X.map(a=>e.jsx("option",{value:a,children:a},a))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"penalty-notes-modal",className:"text-sm font-medium text-slate-600 dark:text-slate-300 mb-1 block",children:"Notas (Opcional)"}),e.jsx("textarea",{id:"penalty-notes-modal",value:r,onChange:a=>u(a.target.value),rows:3,className:"w-full text-sm rounded-lg border border-slate-300 dark:border-slate-600 p-2 bg-white dark:bg-slate-700"})]})]}),e.jsxs("div",{className:"p-4 bg-slate-50 dark:bg-slate-800/50 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3",children:[e.jsx("button",{onClick:N,className:"px-4 py-2 text-sm font-semibold rounded-lg border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700",children:"Cancelar"}),e.jsx("button",{onClick:T,disabled:P.isPending,className:"px-4 py-2 text-sm font-semibold rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:bg-slate-400",children:P.isPending?"Guardando...":"Guardar"})]})]})}):null},Se=({student:n,onDeleteRequest:N,deletingId:c})=>{const[h,A]=p.useState(!1),i=p.useMemo(()=>n.totalScore>=21?{bgColor:"bg-red-50 dark:bg-red-900/30",borderColor:"border-red-200 dark:border-red-600",textColor:"text-red-600 dark:text-red-400",icon:"local_fire_department",ringColor:"ring-red-500/20"}:n.totalScore>=11?{bgColor:"bg-amber-50 dark:bg-amber-900/30",borderColor:"border-amber-200 dark:border-amber-600",textColor:"text-amber-600 dark:text-amber-400",icon:"warning_amber",ringColor:"ring-amber-500/20"}:{bgColor:"bg-yellow-50 dark:bg-yellow-900/30",borderColor:"border-yellow-200 dark:border-yellow-600",textColor:"text-yellow-700 dark:text-yellow-500",icon:"priority_high",ringColor:"ring-yellow-500/20"},[n.totalScore]),f=r=>{if(!r)return"gavel";const u=r.toLowerCase();return u.includes("baja anticipada")?"event_busy":u.includes("baja sobre la fecha")||u.includes("ausencia")?"no_accounts":u.includes("abandono")?"directions_run":u.includes("falta sin aviso")?"person_off":"gavel"};return e.jsxs("div",{className:`rounded-xl border transition-all duration-300 ${h?`shadow-lg ring-4 ${i.ringColor}`:"shadow-sm"} ${i.borderColor}`,children:[e.jsxs("button",{onClick:()=>A(!h),className:"w-full text-left p-4 flex justify-between items-center cursor-pointer","aria-expanded":h,"aria-controls":`penalties-for-${n.legajo}`,children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:`flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-full ${i.bgColor}`,children:e.jsx("span",{className:`material-icons ${i.textColor}`,children:i.icon})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-slate-800 dark:text-slate-100",children:n.nombre}),e.jsxs("p",{className:"text-sm text-slate-500 dark:text-slate-400 font-mono",children:["Legajo: ",n.legajo]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:`text-3xl font-black ${i.textColor}`,children:n.totalScore}),e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400 -mt-1",children:"puntos"})]}),e.jsx("span",{className:`material-icons text-slate-400 transition-transform duration-300 ${h?"rotate-180":""}`,children:"expand_more"})]})]}),h&&e.jsxs("div",{id:`penalties-for-${n.legajo}`,className:"p-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/20",children:[e.jsx("h4",{className:"text-sm font-bold text-slate-600 dark:text-slate-300 mb-3",children:"Historial de Incumplimientos"}),e.jsx("div",{className:"space-y-3",children:n.penalties.map(r=>e.jsxs("div",{className:"p-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex items-start gap-4",children:[e.jsx("span",{className:"material-icons text-slate-400 dark:text-slate-500 mt-1",children:f(r[Z])}),e.jsxs("div",{className:"flex-grow",children:[e.jsxs("div",{className:"flex justify-between items-start gap-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-slate-800 dark:text-slate-100",children:r[Z]}),r.ppsName&&e.jsxs("p",{className:"text-xs text-slate-500 dark:text-slate-400",children:["PPS: ",r.ppsName]})]}),e.jsx("p",{className:"text-xs font-semibold text-slate-500 dark:text-slate-400 whitespace-nowrap",children:U(r[re])})]}),r[V]&&e.jsx("p",{className:"mt-2 text-sm text-slate-600 dark:text-slate-300 border-l-2 border-slate-200 dark:border-slate-600 pl-2 italic",children:r[V]})]}),e.jsx("button",{onClick:()=>N(r.id),disabled:c===r.id,className:"p-1.5 rounded-full text-slate-400 hover:bg-rose-100 hover:text-rose-600 dark:hover:bg-rose-900/50 dark:hover:text-rose-400 disabled:opacity-50","aria-label":"Eliminar penalización",children:c===r.id?e.jsx("div",{className:"w-4 h-4 border-2 border-rose-400/50 border-t-rose-500 rounded-full animate-spin"}):e.jsx("span",{className:"material-icons !text-base",children:"delete_outline"})})]},r.id))})]})]})},Pe=({isTestingMode:n=!1})=>{const[N,c]=p.useState(null),[h,A]=p.useState(!1),[i,f]=p.useState(null),[r,u]=p.useState(null),[x,C]=p.useState(null),L=ee(),{data:S,isLoading:O}=ae({queryKey:["allPenalizedStudents",n],queryFn:async()=>{let t=[],b=[],g=[];if(n)[t,b,g]=await Promise.all([y.getAll("penalizaciones"),y.getAll("estudiantes"),y.getAll("lanzamientos_pps")]);else{const[s,m,o]=await Promise.all([E(q),E(he,[v,w]),E(ie,[I])]);t=s.records.map(fe),b=m.records.map(Ne),g=o.records.map(de)}const _=new Map;b.forEach(s=>{s[v]&&s[w]&&_.set(s.id,{legajo:String(s[v]),nombre:String(s[w])})});const d=new Map;g.forEach(s=>{s[I]&&d.set(s.id,String(s[I]))});const l=new Map;return t.forEach(s=>{const m=s[le],o=Array.isArray(m)?m[0]:m,k=o?_.get(o):null;if(!k)return;l.has(o)||l.set(o,{id:o,legajo:k.legajo,nombre:k.nombre,totalScore:0,penalties:[]});const K=l.get(o),D=s[oe],Q=Array.isArray(D)?D[0]:D,ce={...s,ppsName:Q?d.get(Q):void 0};K.penalties.push(ce),K.totalScore+=s[ne]||0}),Array.from(l.values()).sort((s,m)=>m.totalScore-s.totalScore)}}),P=se({mutationFn:t=>n?y.delete("penalizaciones",t):te(q,t),onSuccess:()=>{f({message:"Penalización eliminada.",type:"success"}),L.invalidateQueries({queryKey:["allPenalizedStudents"]})},onError:()=>{f({message:"Error al eliminar la penalización.",type:"error"})},onSettled:()=>{u(null),C(null)}}),T=t=>{C(t)},a=()=>{x&&(u(x),P.mutate(x))},j=p.useCallback(t=>{if(!t[v]||!t[w]){f({message:"El registro del estudiante está incompleto.",type:"error"});return}c({id:t.id,legajo:String(t[v]),nombre:String(t[w])}),A(!0)},[]);return e.jsxs("div",{className:"space-y-6",children:[i&&e.jsx(me,{message:i.message,type:i.type,onClose:()=>f(null)}),N&&e.jsx(Ee,{isOpen:h,onClose:()=>A(!1),student:N,onSuccess:()=>f({message:"Penalización aplicada con éxito.",type:"success"}),isTestingMode:n}),e.jsx(je,{isOpen:!!x,title:"Eliminar Penalización",message:"¿Estás seguro de que quieres eliminar este registro de penalización? Esta acción afectará el puntaje del alumno y no se puede deshacer.",onConfirm:a,onClose:()=>C(null),confirmText:"Eliminar",cancelText:"Cancelar",type:"danger"}),e.jsx(pe,{title:"Panel de Penalizaciones",icon:"gavel",description:"Aplica y gestiona las penalizaciones por incumplimientos de los estudiantes.",children:e.jsx("div",{className:"mt-4 pt-4 border-t border-slate-200 dark:border-slate-700",children:e.jsx(Ae,{onStudentSelect:j,isTestingMode:n})})}),e.jsx("div",{children:O?e.jsx(ue,{}):S&&S.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:S.map(t=>e.jsx(Se,{student:t,onDeleteRequest:T,deletingId:r},t.id))}):e.jsx(xe,{icon:"verified_user",title:"Sin Penalizaciones",message:"No hay estudiantes con penalizaciones registradas."})})]})};export{Pe as default};
