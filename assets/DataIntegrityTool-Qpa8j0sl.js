import{r as p,g as C,j as t,C as O,a5 as v,as as _,J as b,bz as j,D as w,a$ as M,a_ as k,T as g,bb as P,a6 as x,bw as F,F as h,U,bd as S,bj as B}from"./index-ZXlslG1z.js";const A=s=>{if(s==null)return!1;if(typeof s=="number")return s>0;const r=String(s).replace(/[\[\]"']/g,"").trim();return r.length>2&&r.toLowerCase()!=="null"},n=s=>{if(s==null)return"";let r=s;if(typeof s=="object"){if(Array.isArray(s)&&s.length>0)return n(s[0]);const o=Object.values(s);if(o.length>0)return n(o[0]);r=JSON.stringify(s)}if(r=String(r),r.startsWith("[")&&r.endsWith("]")||r.startsWith('"')&&r.endsWith('"'))try{const o=JSON.parse(r);return n(o)}catch{}return r.replace(/[\[\]\{\}"']/g,"").trim()},q=()=>{const[s,r]=p.useState(!1),[E,o]=p.useState(!1),[I,l]=p.useState(null),T=C(),L=async()=>{r(!0);try{const d=(await b.estudiantes.getAll()).filter(m=>{const u=m[j],y=A(m[w]),N=A(m[M]),a=A(m[k]);return(u==="Nuevo (Sin cuenta)"||!u)&&(y||N||a)});if(d.length===0){l({m:"Los estados de alumnos están sincronizados.",t:"success"});return}const f=d.map(m=>g.from(P).update({[j]:"Inactivo"}).eq("id",m.id));await Promise.all(f),l({m:`¡Éxito! Se corrigieron ${d.length} estados "Nuevo" a "Inactivo".`,t:"success"}),T.invalidateQueries()}catch(c){l({m:`Error técnico: ${c.message}`,t:"error"})}finally{r(!1)}},D=async()=>{o(!0);let c=0;try{const f=(await b.instituciones.getAll({fields:[x]})).filter(a=>{const e=a[x];return e?typeof e=="object"?!0:n(e)!==String(e).trim():!1});console.log(`Instituciones sucias: ${f.length}`);for(const a of f){const e=a[x],i=n(e);i&&i!==e&&(await g.from(F).update({[x]:i}).eq("id",a.id),c++)}const u=(await b.lanzamientos.getAll({fields:[h]})).filter(a=>{const e=a[h];return e?typeof e=="object"?!0:n(e)!==String(e).trim():!1});console.log(`Lanzamientos sucios: ${u.length}`);for(const a of u){const e=a[h],i=n(e);i&&i!==e&&(await g.from(U).update({[h]:i}).eq("id",a.id),c++)}const N=(await b.practicas.getAll({fields:[S]})).filter(a=>{const e=a[S];return e?typeof e=="object"?!0:n(e)!==String(e).trim():!1});console.log(`Prácticas sucias (nombre_institucion): ${N.length}`);for(const a of N){const e=a[S],i=n(e),z=Array.isArray(e)?e[0]:String(e).trim();i&&i!==z&&(await g.from(B).update({[S]:[i]}).eq("id",a.id),c++)}c>0?(l({m:`Se limpiaron ${c} registros con corchetes/comillas en Instituciones, Lanzamientos y Prácticas.`,t:"success"}),T.invalidateQueries()):l({m:"No se encontraron registros sucios. La base de datos está limpia.",t:"success"})}catch(d){console.error(d),l({m:`Error al sanitizar: ${d.message}`,t:"error"})}finally{o(!1)}};return t.jsxs(O,{title:"Mantenimiento de Base de Datos",icon:"auto_fix_high",children:[I&&t.jsx(v,{message:I.m,type:I.t,onClose:()=>l(null)}),t.jsxs("div",{className:"p-4 space-y-6",children:[t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800",children:[t.jsx("h4",{className:"text-sm font-bold text-blue-900 dark:text-blue-100 mb-1",children:"Sincronización de Estados"}),t.jsx("p",{className:"text-xs text-blue-800 dark:text-blue-300 leading-relaxed",children:'Analiza si un alumno tiene datos de contacto (Mail/DNI) pero figura como "Nuevo". Actualiza a "Inactivo" para que pueda operar.'})]}),t.jsx(_,{onClick:L,isLoading:s,disabled:E,icon:"cleaning_services",children:"Sincronizar Estados de Alumnos"})]}),t.jsx("hr",{className:"border-slate-100 dark:border-slate-800"}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 p-4 rounded-xl border border-amber-100 dark:border-amber-800",children:[t.jsx("h4",{className:"text-sm font-bold text-amber-900 dark:text-amber-100 mb-1",children:"Sanitizador de Texto (Migración)"}),t.jsxs("p",{className:"text-xs text-amber-800 dark:text-amber-300 leading-relaxed",children:["Escanea ",t.jsx("strong",{children:"Instituciones, Lanzamientos y Prácticas"})," y elimina caracteres basura como ",t.jsx("code",{children:'["..."]'}),", ",t.jsx("code",{children:"{...}"})," o comillas extra que quedaron de la importación."]})]}),t.jsx(_,{onClick:D,isLoading:E,disabled:s,icon:"spellcheck",className:"bg-amber-600 hover:bg-amber-700 text-white",children:"Limpiar Corchetes y Comillas"})]})]})]})};export{q as default};
