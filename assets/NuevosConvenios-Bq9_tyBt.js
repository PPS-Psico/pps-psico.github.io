import{g as S,r as D,O as z,i as A,J as v,bv as I,a6 as y,n as F,p,h as l,F as T,j as t,aP as M,N as O,a5 as k,C as b,M as Y,as as L}from"./index-ZXlslG1z.js";const P=r=>r?r.split(/\s*[-–—]\s*/)[0].trim():"Sin Nombre",R=({isTestingMode:r=!1})=>{const j=S(),[f,x]=D.useState(null),{data:d,isLoading:w,error:C}=z({queryKey:["conveniosData",r],queryFn:async()=>{if(r)return{instituciones:[{id:"inst_test_1",createdTime:"",[y]:"Inst Test Nueva",[I]:2024},{id:"inst_test_2",createdTime:"",[y]:"Inst Test Potencial"}],lanzamientos:[{id:"lanz_test_1",createdTime:"",[T]:"Inst Test Nueva - Sede A",[l]:`${new Date().getFullYear()}-03-01`},{id:"lanz_test_2",createdTime:"",[T]:"Inst Test Potencial - Taller B",[l]:`${new Date().getFullYear()}-04-01`}]};const[s,n]=await Promise.all([v.instituciones.getAll(),v.lanzamientos.getAll()]);return{instituciones:s,lanzamientos:n}}}),N=A({mutationFn:s=>{const n=new Date().getFullYear();return r?(console.log("TEST MODE: Confirming agreement for",s),new Promise(g=>setTimeout(g,500))):v.instituciones.update(s,{[I]:n})},onSuccess:()=>{x({message:"Convenio confirmado con éxito.",type:"success"}),j.invalidateQueries({queryKey:["conveniosData",r]}),j.invalidateQueries({queryKey:["metricsData"]})},onError:s=>{x({message:`Error al confirmar: ${s.message}`,type:"error"})}}),{confirmed:E,potentials:_}=D.useMemo(()=>{if(!d)return{confirmed:[],potentials:[]};const s=new Date().getFullYear(),n=new Map;d.instituciones.forEach(e=>{const a=e[y];if(a){const i=Number(e[I]),c=!isNaN(i)&&i>=s-1;n.set(F(a),{id:e.id,isNew:c,year:i})}});const g=d.lanzamientos.filter(e=>{const a=p(e[l]);return a&&a.getUTCFullYear()===s}).sort((e,a)=>{var o,m;const i=((o=p(e[l]))==null?void 0:o.getTime())||0,c=((m=p(a[l]))==null?void 0:m.getTime())||0;return i-c}),h=new Map,u=new Map;return g.forEach(e=>{const a=e[T];if(!a)return;const i=P(a),c=F(i),o=n.get(c);if(o)if(o.isNew){if(!h.has(i)){const m=p(e[l]);m&&h.set(i,m)}}else u.has(o.id)||u.set(o.id,{institutionId:o.id,institutionName:i,launches:[]}),u.get(o.id).launches.push({id:e.id,name:a,date:e[l]||"N/A"})}),{confirmed:Array.from(h.entries()).map(([e,a])=>({name:e,date:a})).sort((e,a)=>e.date.getTime()-a.date.getTime()).map(e=>e.name),potentials:Array.from(u.values()).sort((e,a)=>e.institutionName.localeCompare(a.institutionName))}},[d]);return w?t.jsx("div",{className:"flex justify-center p-8",children:t.jsx(M,{})}):C?t.jsx(O,{icon:"error",title:"Error",message:C.message}):t.jsxs("div",{className:"space-y-8",children:[f&&t.jsx(k,{message:f.message,type:f.type,onClose:()=>x(null)}),t.jsx(b,{icon:"verified",title:`Convenios Nuevos Confirmados (${new Date().getFullYear()})`,description:"Instituciones marcadas como 'Convenio Nuevo' que tuvieron lanzamientos este año.",children:E.length>0?t.jsx("ul",{className:"mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3",children:E.map(s=>t.jsxs("li",{className:"flex items-center gap-2 text-sm",children:[t.jsx("span",{className:"material-icons text-emerald-500 !text-base",children:"check_circle"}),t.jsx("span",{className:"text-slate-700 dark:text-slate-200",children:s})]},s))}):t.jsx("p",{className:"mt-4 text-sm text-slate-500 dark:text-slate-400",children:"No se han confirmado convenios nuevos este año."})}),t.jsx(b,{icon:"add_business",title:"Posibles Convenios Nuevos a Confirmar",description:"Instituciones con lanzamientos este año que no están marcadas con el año de convenio.",children:_.length>0?t.jsx("div",{className:"mt-4 space-y-4",children:_.map(s=>t.jsxs("div",{className:"p-4 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/50 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[t.jsxs("div",{children:[t.jsx("h4",{className:"font-bold text-slate-800 dark:text-slate-100",children:s.institutionName}),t.jsx("ul",{className:"mt-2 space-y-1 text-xs text-slate-600 dark:text-slate-400",children:s.launches.map(n=>t.jsxs("li",{children:["- ",n.name," (",Y(n.date),")"]},n.id))})]}),t.jsxs(L,{size:"sm",onClick:()=>N.mutate(s.institutionId),isLoading:N.isPending&&N.variables===s.institutionId,icon:"add_task",children:["Confirmar ",new Date().getFullYear()]})]},s.institutionId))}):t.jsx("p",{className:"mt-4 text-sm text-slate-500 dark:text-slate-400",children:"¡Excelente! Todas las instituciones con lanzamientos este año están correctamente marcadas."})})]})};export{R as default};
