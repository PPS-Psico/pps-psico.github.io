const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./jszip.min-DGxRf717.js","./index-ZXlslG1z.js","./index-BZxwZwPS.css","./_commonjs-dynamic-modules-TDtrdbi3.js","./FileSaver.min-iB6v0HDW.js"])))=>i.map(i=>d[i]);
import{r as g,g as re,O as ne,i as B,Q as L,Y as z,J as R,bx as M,by as T,b8 as Y,bz as q,bA as ge,n as $,D as G,I as K,G as Q,bB as ee,a0 as he,bC as le,bD as ie,bE as oe,bF as J,X as fe,bG as je,bb as ve,bH as Ne,j as e,aP as de,N as W,a5 as ce,bI as we,M as ye,T as X,b0 as te,d as ke,bJ as _e,K as Z,bK as Se}from"./index-ZXlslG1z.js";import{s as ue}from"./emailService-DD1-Dxe1.js";import{C as me}from"./CollapsibleSection-DXbQB952.js";import{C as xe}from"./ConfirmModal-DfSwa4qW.js";import{S as Ee}from"./SubTabs-B9w5BDf5.js";import"./UnifiedTabs-xSvmzb6C.js";import"./proxy-BFxRqQFC.js";const Ce=(t=!1)=>{const[r,f]=g.useState(""),[x,u]=g.useState(null),_=re(),{data:j=[],isLoading:S,error:v}=ne({queryKey:["finalizacionRequests",t],queryFn:async()=>{if(t){const c=await L.getAll("finalizacion_pps"),s=await L.getAll("estudiantes"),a=new Map(s.map(n=>[n.id,n]));return c.map(n=>{const i=n[T],b=a.get(i);return{...n,studentName:(b==null?void 0:b[Q])||"Desconocido",studentLegajo:(b==null?void 0:b[K])||"---",studentEmail:(b==null?void 0:b[G])||"",createdTime:n.created_at}}).sort((n,i)=>new Date(i.createdTime).getTime()-new Date(n.createdTime).getTime())}const{records:o,error:l}=await ee(fe,[he,z,T,le,ie,oe,J]);if(l)throw new Error(typeof l.error=="string"?l.error:l.error.message);const d=o.map(je),p=[...new Set(d.map(c=>M(c[T])).filter(Boolean))],{records:h}=await ee(ve,[Q,K,G],{id:p}),N=h.map(Ne),m=new Map(N.map(c=>[c.id,c]));return d.map(c=>{const s=M(c[T]),a=s?m.get(s):null;return{...c,studentName:(a==null?void 0:a[Q])||"Desconocido",studentLegajo:(a==null?void 0:a[K])||"---",studentEmail:(a==null?void 0:a[G])||"",createdTime:c.createdTime||c.created_at||new Date().toISOString()}}).sort((c,s)=>new Date(s.createdTime).getTime()-new Date(c.createdTime).getTime())}}),y=B({mutationFn:async({id:o,status:l})=>{const d=j.find(h=>h.id===o);if(!d)throw new Error("Solicitud no encontrada");if(t)return await L.update("finalizacion_pps",o,{[z]:l}),{emailSuccess:!0};await R.finalizacion.update(o,{[z]:l});let p={success:!0,message:"No se requiere email"};if(l==="Cargado"){const h=M(d[T]);h&&await R.estudiantes.update(h,{[q]:"Finalizado",[Y]:new Date().toISOString()}),d.studentEmail&&(p=await ue("sac",{studentName:d.studentName,studentEmail:d.studentEmail,ppsName:"Práctica Profesional Supervisada"}))}return{emailSuccess:p.success,emailMessage:p.message}},onSuccess:(o,l)=>{_.invalidateQueries({queryKey:["finalizacionRequests"]}),l.status==="Cargado"?o.emailSuccess?u({message:"Acreditación confirmada y email enviado.",type:"success"}):u({message:`Cargado con éxito, pero falló el email: ${o.emailMessage}`,type:"warning"}):u({message:"Estado actualizado correctamente.",type:"success"})},onError:o=>{u({message:`Error al actualizar: ${o.message}`,type:"error"})}}),w=B({mutationFn:async o=>{const l=M(o[T]);if(l){const d={[Y]:null,[q]:"Activo"};t?await L.update("estudiantes",String(l),d):await R.estudiantes.update(String(l),d)}if(t)await L.delete("finalizacion_pps",o.id);else{const{error:d}=await ge(o.id);if(d)throw new Error(d.message)}},onSuccess:()=>{u({message:"Solicitud eliminada y estado revertido.",type:"success"}),_.invalidateQueries({queryKey:["finalizacionRequests"]}),_.invalidateQueries({queryKey:["student"]})}}),{activeList:k,historyList:E}=g.useMemo(()=>{const o=[],l=[],d=r.toLowerCase();return j.forEach(p=>{if(r&&!p.studentName.toLowerCase().includes(d)&&!String(p.studentLegajo).includes(d))return;$(p[z])==="cargado"?l.push(p):o.push(p)}),{activeList:o,historyList:l}},[j,r]);return{isLoading:S,error:v,searchTerm:r,setSearchTerm:f,toastInfo:x,setToastInfo:u,updateStatusMutation:y,deleteMutation:w,activeList:k,historyList:E}},Ie=t=>{var f;if(!t)return"other";const r=(f=t.split(".").pop())==null?void 0:f.toLowerCase();return["jpg","jpeg","png","gif","webp","svg","bmp"].includes(r||"")?"image":r==="pdf"?"pdf":["doc","docx","xls","xlsx","ppt","pptx"].includes(r||"")?"office":"other"},pe=t=>{if(!t)return null;try{const r=t.split("/documentos_finalizacion/");return r.length>1?decodeURIComponent(r[1]):null}catch(r){return console.error("Error parsing storage path:",r),null}},Le=t=>{if(!t)return"";const r=t[z],f=Array.isArray(r)?r[0]:r;return $(f||"")},V=t=>{if(!t)return[];let r=t;if(typeof r=="string")try{r=JSON.parse(r)}catch{return[{url:r,filename:"Archivo Adjunto",type:"unknown"}]}return(Array.isArray(r)?r:[r]).map(x=>typeof x=="string"?{url:x,filename:"Archivo Adjunto",type:"unknown"}:{url:x.url||x.signedUrl||"",filename:x.filename||x.name||"Archivo",type:x.type}).filter(x=>!!x.url)},Ae=({files:t,initialIndex:r,isOpen:f,onClose:x})=>{const[u,_]=g.useState(r),[j,S]=g.useState(!0),[v,y]=g.useState([]),[w,k]=g.useState(!1),[E,o]=g.useState(!1);g.useEffect(()=>(f?(_(r),o(!1),k(!1),document.body.style.overflow="hidden"):document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[f,r]),g.useEffect(()=>{if(!f||t.length===0)return;(async()=>{const c=t.map(async a=>{const n=pe(a.url);if(!n)return a.url;try{const{data:i,error:b}=await X.storage.from("documentos_finalizacion").createSignedUrl(n,3600);return b||!i?a.url:i.signedUrl}catch{return a.url}}),s=await Promise.all(c);y(s),k(!0),S(!1)})()},[f,t]);const l=m=>{m==null||m.stopPropagation(),S(!0),_(c=>(c+1)%t.length)},d=m=>{m==null||m.stopPropagation(),S(!0),_(c=>(c-1+t.length)%t.length)};if(!f||t.length===0)return null;const p=t[u],h=w?v[u]:null,N=Ie(p.filename);return we.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[9999] bg-black/95 backdrop-blur-md flex flex-col animate-fade-in",onClick:x,children:[e.jsxs("div",{className:"flex-shrink-0 flex justify-between items-center p-4 text-white z-50 h-16 bg-gradient-to-b from-black/80 to-transparent",onClick:m=>m.stopPropagation(),children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("h3",{className:"font-bold text-lg truncate max-w-md",children:p.filename}),e.jsxs("span",{className:"text-xs text-gray-400",children:[u+1," de ",t.length]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[w&&e.jsx("a",{href:h,download:!0,target:"_blank",rel:"noopener noreferrer",className:"p-2 rounded-full hover:bg-white/10 transition-colors text-gray-300 hover:text-white",children:e.jsx("span",{className:"material-icons",children:"download"})}),e.jsx("button",{onClick:x,className:"p-2 rounded-full hover:bg-white/20 transition-colors",children:e.jsx("span",{className:"material-icons",children:"close"})})]})]}),e.jsxs("div",{className:"flex-grow relative flex items-center justify-center p-4 overflow-hidden",onClick:m=>m.stopPropagation(),children:[w?E||!h?e.jsx("div",{className:"text-white",children:"Error al cargar"}):N==="image"?e.jsx("img",{src:h,alt:"",className:"max-w-full max-h-full object-contain",onLoad:()=>S(!1)}):N==="pdf"?e.jsx("iframe",{src:h,className:"w-[90vw] h-[85vh] bg-white rounded-lg",title:"PDF"}):N==="office"?e.jsx("iframe",{src:`https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(h)}`,className:"w-[90vw] h-[85vh] bg-white rounded-lg",title:"Office Document"}):e.jsxs("div",{className:"text-white text-center",children:[e.jsx("span",{className:"material-icons !text-6xl mb-4 opacity-80",children:"description"}),e.jsx("p",{className:"mb-6",children:"Vista previa no disponible."}),e.jsx("a",{href:h,download:!0,className:"bg-blue-600 px-6 py-3 rounded-xl font-bold",children:"Descargar"})]}):e.jsx("div",{className:"w-10 h-10 border-4 border-white/30 border-t-white rounded-full animate-spin"}),t.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:d,className:"absolute left-6 p-3 rounded-full bg-black/40 hover:bg-black/70 text-white/70 hover:text-white transition-all",children:e.jsx("span",{className:"material-icons !text-3xl",children:"chevron_left"})}),e.jsx("button",{onClick:l,className:"absolute right-6 p-3 rounded-full bg-black/40 hover:bg-black/70 text-white/70 hover:text-white transition-all",children:e.jsx("span",{className:"material-icons !text-3xl",children:"chevron_right"})})]})]})]}),document.body)},ae=({request:t,onUpdateStatus:r,onDeleteRequest:f,onCopy:x,isUpdating:u,searchTerm:_,onPreview:j,isArchived:S=!1})=>{const[v,y]=g.useState(!1),[w,k]=g.useState(!1),E=Le(t),o=E==="cargado",l=E==="en proceso";let d="Pendiente",p="bg-amber-500";o?(d="Finalizada",p="bg-emerald-500"):l&&(d="En Proceso SAC",p="bg-indigo-500");const h=o?"bg-emerald-100 text-emerald-700 border-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-300 dark:border-emerald-800":l?"bg-indigo-100 text-indigo-700 border-indigo-200 dark:bg-indigo-900/30 dark:text-indigo-300 dark:border-indigo-800":"bg-amber-100 text-amber-700 border-amber-200 dark:bg-amber-900/30 dark:text-amber-400 dark:border-amber-800",N=V(t[ie]),m=V(t[le]),c=V(t[oe]),s=[...N,...m,...c],a=async i=>{if(i.stopPropagation(),s.length!==0){k(!0);try{const b=(await te(async()=>{const{default:A}=await import("./jszip.min-DGxRf717.js").then(P=>P.j);return{default:A}},__vite__mapDeps([0,1,2,3]),import.meta.url)).default,C=(await te(async()=>{const{default:A}=await import("./FileSaver.min-iB6v0HDW.js").then(P=>P.F);return{default:A}},__vite__mapDeps([4,1,2]),import.meta.url)).default,D=new b,F=D.folder(`Acreditacion_${t.studentName}_${t.studentLegajo}`);await Promise.all(s.map(async A=>{try{const P=pe(A.url);let U=null;if(P){const{data:O,error:be}=await X.storage.from("documentos_finalizacion").download(P);!be&&O&&(U=O)}else U=await fetch(A.url).then(O=>O.blob());U&&(F==null||F.file(A.filename,U))}catch{}}));const H=await D.generateAsync({type:"blob"});C.saveAs(H,`Acreditacion_${t.studentLegajo}.zip`)}finally{k(!1)}}},n=i=>{i.stopPropagation();const C=new Date().toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric"}),D=t.studentLegajo||"",F=t.studentName||"",H=`${C}	${D}	${F}`;x(H)};return e.jsxs("div",{className:`group relative bg-white dark:bg-slate-900 rounded-xl border transition-all duration-300 ${v?"border-blue-400 dark:border-indigo-500 ring-1 ring-blue-100 dark:ring-indigo-500/30 shadow-lg":"border-slate-200 dark:border-slate-800 hover:border-blue-300 dark:hover:border-indigo-500 shadow-sm"}`,children:[e.jsx("div",{className:`absolute left-0 top-0 bottom-0 w-1.5 transition-all ${v?"w-1":"w-1.5"} ${p} rounded-l-xl`}),e.jsxs("div",{onClick:()=>y(!v),className:"p-4 pl-6 cursor-pointer flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4 min-w-0",children:[e.jsx("div",{className:`flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm border ${o?"bg-emerald-50 text-emerald-600 dark:bg-emerald-950 dark:text-emerald-400 dark:border-emerald-800":"bg-slate-100 text-slate-500 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700"}`,children:t.studentName.charAt(0)}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h4",{className:"font-bold text-slate-800 dark:text-slate-100 truncate text-base",children:t.studentName}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 mt-0.5",children:[e.jsx("span",{className:"font-mono bg-slate-50 dark:bg-slate-800 px-1.5 rounded border border-slate-100 dark:border-slate-700",children:t.studentLegajo}),e.jsx("span",{children:"•"}),e.jsxs("span",{children:["Solicitado: ",ye(t.createdTime)]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 self-end sm:self-center",children:[s.length>0&&e.jsxs("button",{onClick:a,disabled:w,className:"flex items-center gap-1 text-xs font-medium text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-3 py-1 rounded-lg border border-blue-100 dark:border-blue-800 transition-colors",children:[w?e.jsx("div",{className:"w-3 h-3 border-2 border-current border-t-transparent rounded-full animate-spin"}):e.jsx("span",{className:"material-icons !text-sm",children:"download"})," ","ZIP"]}),e.jsx("span",{className:`text-[10px] font-bold px-2 py-0.5 rounded border uppercase tracking-wide ${h}`,children:d}),e.jsx("div",{className:`text-slate-400 transition-transform duration-300 ${v?"rotate-180":""}`,children:e.jsx("span",{className:"material-icons !text-xl",children:"expand_more"})})]})]}),e.jsx("div",{className:`grid transition-all duration-500 ease-in-out ${v?"grid-rows-[1fr] opacity-100 border-t border-slate-100 dark:border-slate-800":"grid-rows-[0fr] opacity-0 h-0 overflow-hidden"}`,children:e.jsxs("div",{className:"overflow-hidden p-6 space-y-6",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[{l:"Planilla Horas",f:N,i:"table_view"},{l:"Informe Final",f:m,i:"description"},{l:"Asistencias",f:c,i:"verified_user"}].map((i,b)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("h5",{className:"text-xs font-bold text-slate-400 uppercase tracking-wider",children:i.l}),i.f.length>0?i.f.map((C,D)=>e.jsxs("button",{onClick:()=>j(s,s.indexOf(C)),className:"w-full flex items-center gap-2 p-2 rounded-lg bg-slate-50 dark:bg-slate-800/50 hover:bg-blue-50 dark:hover:bg-indigo-950 border border-slate-200 dark:border-slate-700 transition-colors text-left",children:[e.jsx("span",{className:"material-icons !text-lg text-slate-400",children:i.i}),e.jsx("span",{className:"text-xs font-medium truncate flex-1 text-slate-600 dark:text-slate-300",children:C.filename})]},D)):e.jsx("p",{className:"text-xs text-slate-400 italic",children:"No adjunto"})]},b))}),t[J]&&e.jsxs("div",{className:"p-3 bg-amber-50 dark:bg-amber-900/10 border border-amber-100 dark:border-amber-800 rounded-lg",children:[e.jsx("h6",{className:"text-xs font-bold text-amber-700 dark:text-amber-500 mb-1",children:"Sugerencias del alumno"}),e.jsxs("p",{className:"text-xs text-slate-600 dark:text-slate-400 italic",children:['"',t[J],'"']})]}),e.jsxs("div",{className:"flex justify-between items-center pt-4 border-t border-slate-100 dark:border-slate-800",children:[e.jsxs("button",{onClick:()=>f(t),disabled:u,className:"text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/30 px-3 py-1.5 rounded-lg text-xs font-bold transition-colors flex items-center gap-1",children:[e.jsx("span",{className:"material-icons !text-sm",children:"delete"})," Eliminar"]}),!S&&e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:n,className:"px-4 py-2 rounded-lg text-xs font-bold bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700 flex items-center gap-2",children:[e.jsx("span",{className:"material-icons !text-sm",children:"content_copy"})," Copiar"]}),e.jsx("button",{onClick:()=>r(t.id,"En Proceso"),disabled:u||l||o,className:`px-4 py-2 rounded-lg text-xs font-bold ${l?"bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300":"bg-white border border-slate-300 text-slate-600 dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300"}`,children:l?"En Proceso":"Marcar en Proceso"}),e.jsxs("button",{onClick:()=>r(t.id,"Cargado"),disabled:u,className:"px-5 py-2 rounded-lg text-xs font-bold text-white bg-emerald-600 hover:bg-emerald-700 shadow-md flex items-center gap-2",children:[e.jsx("span",{className:"material-icons !text-sm",children:"check_circle"})," Confirmar SAC"]})]})]})]})})]})},Pe=({isTestingMode:t=!1})=>{const{isLoading:r,error:f,searchTerm:x,setSearchTerm:u,toastInfo:_,setToastInfo:j,updateStatusMutation:S,deleteMutation:v,activeList:y,historyList:w}=Ce(t),[k,E]=g.useState([]),[o,l]=g.useState(!1),[d,p]=g.useState(null),h=N=>{navigator.clipboard.writeText(N).then(()=>{j({message:"Datos copiados para Excel.",type:"success"})})};return r?e.jsx(de,{}):f?e.jsx(W,{icon:"error",title:"Error",message:"No se pudieron cargar las solicitudes."}):e.jsxs("div",{className:"space-y-8 animate-fade-in-up",children:[_&&e.jsx(ce,{message:_.message,type:_.type,onClose:()=>j(null)}),o&&e.jsx(Ae,{isOpen:o,onClose:()=>l(!1),files:k,initialIndex:0}),e.jsx(xe,{isOpen:!!d,title:"¿Eliminar solicitud de acreditación?",message:"Se borrarán los archivos y el estado del estudiante volverá a 'Activo'. ¿Continuar?",confirmText:"Confirmar eliminación",type:"danger",onConfirm:()=>d&&v.mutate(d),onClose:()=>p(null)}),e.jsx("div",{className:"p-4 bg-slate-50 dark:bg-gray-900/50 rounded-xl border border-slate-200 dark:border-slate-700",children:e.jsxs("div",{className:"relative w-full md:w-96",children:[e.jsx("input",{type:"text",placeholder:"Buscar por estudiante o legajo...",value:x,onChange:N=>u(N.target.value),className:"w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-gray-800 text-sm focus:ring-2 focus:ring-blue-500 outline-none text-slate-900 dark:text-white"}),e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 material-icons text-slate-400",children:"search"})]})}),y.length>0?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"text-sm font-bold text-slate-500 dark:text-slate-400 uppercase flex items-center gap-2 px-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-amber-500 animate-pulse"})," Pendientes (",y.length,")"]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:y.map(N=>e.jsx(ae,{request:N,onUpdateStatus:(m,c)=>S.mutate({id:m,status:c}),onDeleteRequest:p,onCopy:h,isUpdating:S.isPending||v.isPending,searchTerm:x,onPreview:m=>{E(m),l(!0)}},N.id))})]}):e.jsxs("div",{className:"py-12 bg-slate-50/50 dark:bg-slate-900/20 rounded-xl border border-dashed border-slate-200 dark:border-slate-800 flex flex-col items-center justify-center text-slate-400",children:[e.jsx("span",{className:"material-icons !text-4xl mb-2 opacity-50",children:"task_alt"}),e.jsx("p",{className:"font-medium",children:"No hay solicitudes pendientes"})]}),w.length>0&&e.jsx(me,{title:"Historial",count:w.length,icon:"history",iconBgColor:"bg-slate-100 dark:bg-gray-800",iconColor:"text-slate-500 dark:text-slate-400",borderColor:"border-slate-200 dark:border-slate-700",defaultOpen:!1,children:e.jsx("div",{className:"grid grid-cols-1 gap-4 mt-4",children:w.map(N=>e.jsx(ae,{request:N,onUpdateStatus:()=>{},onDeleteRequest:p,onCopy:h,isUpdating:v.isPending,searchTerm:x,onPreview:m=>{E(m),l(!0)},isArchived:!0},N.id))})})]})},De=t=>t||e.jsx("span",{className:"text-slate-300 dark:text-slate-600 italic text-xs",children:"No especificado"}),I=({label:t,value:r,icon:f,fullWidth:x})=>e.jsxs("div",{className:`${x?"col-span-full":""} bg-white dark:bg-slate-800 p-3 rounded-lg border border-slate-100 dark:border-slate-700/50 shadow-sm`,children:[e.jsxs("div",{className:"flex items-center gap-1.5 mb-1",children:[f&&e.jsx("span",{className:"material-icons text-slate-400 !text-sm",children:f}),e.jsx("span",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-wider",children:t})]}),e.jsx("p",{className:"text-sm font-medium text-slate-800 dark:text-slate-200 break-words whitespace-pre-wrap leading-snug",children:De(r)})]}),se=({req:t,onDeleteRequest:r,onUpdate:f,isUpdatingParent:x})=>{const[u,_]=g.useState(!1),[j,S]=g.useState(t.estado_seguimiento||"Pendiente"),[v,y]=g.useState(t.notas||""),[w,k]=g.useState(!1),[E,o]=g.useState(!1),l=_e(j),d=$(j),p=t._daysSinceUpdate>4&&!["finalizada","cancelada","rechazada","archivado","realizada","no se pudo concretar"].includes(d),h=t.nombre_institucion,N=t.email_institucion;t.actualizacion||t.created_at,g.useEffect(()=>{o(j!==(t.estado_seguimiento||"Pendiente")||v!==(t.notas||""))},[j,v,t]);const m=async a=>{a.stopPropagation(),E&&(k(!0),await f(t.id,{estado_seguimiento:j,notas:v}),k(!1),o(!1))},c=a=>{a.stopPropagation();const n=`Propuesta de Convenio PPS - UFLO - Alumno: ${t._studentName}`,i=`Estimados ${h},

Me comunico desde la coordinación de Prácticas Profesionales...
`,b=`mailto:${N}?subject=${encodeURIComponent(n)}&body=${encodeURIComponent(i)}`;window.open(b,"_blank"),j==="Pendiente"&&(S("En conversaciones"),o(!0))},s=a=>{a.stopPropagation(),S(t.estado_seguimiento||"Pendiente"),y(t.notas||""),_(!1)};return e.jsxs("div",{className:`group relative bg-white dark:bg-slate-900 rounded-xl border transition-all duration-300 overflow-hidden ${u?"border-blue-400 dark:border-blue-600 ring-1 ring-blue-100 dark:ring-blue-900/30 shadow-lg":"border-slate-200 dark:border-slate-800 hover:border-blue-300 dark:hover:border-blue-700 shadow-sm"} ${p&&!u?"border-amber-200 dark:border-amber-900/50 bg-amber-50/30 dark:bg-amber-900/10":""}`,children:[e.jsx("div",{className:`absolute left-0 top-0 bottom-0 w-1 transition-all duration-300 ${u?"w-1":"w-1.5"} ${l.accentBg}`}),e.jsx("div",{onClick:()=>_(!u),className:"p-4 pl-5 cursor-pointer",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-4 min-w-0",children:[e.jsx("div",{className:`flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm border transition-colors ${u?"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300":"bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-400"}`,children:t._studentName.charAt(0)}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-bold text-slate-800 dark:text-slate-100 truncate text-base",children:h||"Institución s/n"}),p&&!u&&e.jsx("span",{className:"text-[10px] font-bold bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400 px-1.5 py-0.5 rounded",children:"!"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 mt-0.5",children:[e.jsx("span",{className:"font-medium",children:t._studentName}),e.jsx("span",{className:"text-slate-300 dark:text-slate-600",children:"•"}),e.jsx("span",{className:"font-mono",children:t._studentLegajo})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 self-end sm:self-center pl-14 sm:pl-0",children:[e.jsx("span",{className:`text-[10px] font-bold px-2.5 py-1 rounded-full border uppercase tracking-wide ${l.labelClass}`,children:j}),e.jsx("span",{className:`material-icons text-slate-400 transition-transform duration-300 ${u?"rotate-180":""}`,children:"expand_more"})]})]})}),u&&e.jsx("div",{className:"border-t border-slate-100 dark:border-slate-800 p-5 bg-slate-50/50 dark:bg-slate-900/50",children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-8",children:[e.jsxs("div",{className:"flex-1 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-slate-200 dark:border-slate-700",children:[e.jsx("span",{className:"material-icons text-slate-400 !text-lg",children:"business"}),e.jsx("h5",{className:"font-bold text-xs uppercase text-slate-600 dark:text-slate-300",children:"Datos Institucionales"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsx(I,{label:"Localidad",value:t.localidad,icon:"location_on"}),e.jsx(I,{label:"Dirección",value:t.direccion_completa,icon:"map"}),e.jsx(I,{label:"Referente",value:t.referente_institucion,icon:"person"}),e.jsx(I,{label:"Email Contacto",value:t.email_institucion,icon:"email"}),e.jsx(I,{label:"Teléfono",value:t.telefono_institucion,icon:"phone"}),e.jsx(I,{label:"Lic. Psicología (Tutor)",value:t.contacto_tutor,icon:"psychology"})]}),e.jsxs("div",{className:"flex gap-4 mt-2",children:[e.jsxs("div",{className:`flex-1 p-3 rounded-lg border flex items-center justify-between ${t.convenio_uflo==="Sí"||t.convenio_uflo==="Si"?"bg-emerald-50 border-emerald-200 text-emerald-800":"bg-slate-50 border-slate-200 text-slate-500"}`,children:[e.jsx("span",{className:"text-xs font-bold uppercase",children:"Convenio UFLO"}),e.jsx("span",{className:"material-icons !text-lg",children:t.convenio_uflo==="Sí"||t.convenio_uflo==="Si"?"check_circle":"help_outline"})]}),e.jsxs("div",{className:`flex-1 p-3 rounded-lg border flex items-center justify-between ${t.tutor_disponible==="Sí"||t.tutor_disponible==="Si"?"bg-emerald-50 border-emerald-200 text-emerald-800":"bg-rose-50 border-rose-200 text-rose-800"}`,children:[e.jsx("span",{className:"text-xs font-bold uppercase",children:"Tutor Disponible"}),e.jsx("span",{className:"material-icons !text-lg",children:t.tutor_disponible==="Sí"||t.tutor_disponible==="Si"?"check_circle":"cancel"})]})]})]}),e.jsxs("div",{className:"flex-1 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-slate-200 dark:border-slate-700",children:[e.jsx("span",{className:"material-icons text-slate-400 !text-lg",children:"description"}),e.jsx("h5",{className:"font-bold text-xs uppercase text-slate-600 dark:text-slate-300",children:"Detalles de la Práctica"})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsx(I,{label:"Modalidad",value:t.tipo_practica,icon:"group_work"}),e.jsx(I,{label:"Descripción de Actividades",value:t.descripcion_institucion,icon:"article",fullWidth:!0})]}),e.jsxs("div",{className:"mt-6 pt-4 border-t border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("span",{className:"material-icons text-slate-400 !text-lg",children:"tune"}),e.jsx("h5",{className:"font-bold text-xs uppercase text-slate-600 dark:text-slate-300",children:"Gestión Interna"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5",children:"Estado"}),e.jsxs("select",{value:j,onChange:a=>S(a.target.value),className:"w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm font-medium focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer",children:[e.jsx("option",{value:"Pendiente",children:"Pendiente"}),e.jsx("option",{value:"En conversaciones",children:"En conversaciones"}),e.jsx("option",{value:"Realizando convenio",children:"Realizando convenio"}),e.jsx("option",{value:"Realizada",children:"Realizada"}),e.jsx("option",{value:"No se pudo concretar",children:"No se pudo concretar"}),e.jsx("option",{value:"Archivado",children:"Archivado"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5",children:"Notas Internas (Visible al alumno solo si falla)"}),e.jsx("textarea",{value:v,onChange:a=>y(a.target.value),rows:3,className:"w-full p-3 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none placeholder:text-slate-400",placeholder:"Bitácora de gestión..."})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-transparent",children:[t.email_institucion&&e.jsxs("button",{onClick:c,className:"mr-auto px-3 py-2 text-xs font-bold text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg flex items-center gap-1 transition-colors",children:[e.jsx("span",{className:"material-icons !text-sm",children:"mail"})," Contactar"]}),e.jsx("button",{onClick:s,className:"px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700 transition-colors",children:"Cancelar"}),e.jsx("button",{onClick:a=>{a.stopPropagation(),r(t.id)},className:"px-3 py-2 text-rose-600 hover:bg-rose-50 rounded-lg flex items-center justify-center transition-colors border border-transparent hover:border-rose-100",title:"Eliminar solicitud",children:e.jsx("span",{className:"material-icons !text-lg",children:"delete"})}),e.jsxs("button",{onClick:m,disabled:!E||w,className:"px-5 py-2 text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-sm disabled:opacity-50 transition-all flex items-center gap-2",children:[w?e.jsx("div",{className:"w-4 h-4 border-2 border-white/50 border-t-white rounded-full animate-spin"}):e.jsx("span",{className:"material-icons !text-lg",children:"save"}),"Guardar"]})]})]})]})})]})},Me=({isTestingMode:t=!1})=>{const r=ke(),[f,x]=g.useState("ingreso"),[u,_]=g.useState(""),[j,S]=g.useState("all"),[v,y]=g.useState(null),[w,k]=g.useState(null),E=re();g.useEffect(()=>{const a=new URLSearchParams(r.search).get("tab");a==="egreso"?x("egreso"):a==="ingreso"&&x("ingreso")},[r.search]);const o=[{id:"ingreso",label:"Solicitudes de PPS",icon:"login"},{id:"egreso",label:"Solicitudes de Finalización",icon:"logout"}],{data:l,isLoading:d,error:p}=ne({queryKey:["adminSolicitudes",t],queryFn:async()=>{if(t)return(await L.getAll("solicitudes_pps")).map(i=>({...i,_studentName:i.nombre_alumno||"Estudiante Mock",_studentLegajo:i.legajo||"12345",_studentEmail:i.email,_daysSinceUpdate:0}));const{data:s,error:a}=await X.from(Se).select("*, estudiantes!fk_solicitud_estudiante(nombre, legajo, correo)").order("created_at",{ascending:!1});if(a)throw new Error(a.message);return s.map(n=>{const i=n.estudiantes,b=new Date(n.actualizacion||n.created_at||Date.now());return{...n,id:String(n.id),createdTime:n.created_at,_studentName:(i==null?void 0:i.nombre)||n.nombre_alumno||"Estudiante",_studentLegajo:(i==null?void 0:i.legajo)||n.legajo||"---",_studentEmail:(i==null?void 0:i.correo)||n.email,_daysSinceUpdate:Math.floor((new Date().getTime()-b.getTime())/(1e3*3600*24))}})}}),h=B({mutationFn:async({recordId:s,fields:a})=>{if(t)return await L.update("solicitudes_pps",s,a);const n=l==null?void 0:l.find(i=>i.id===s);return n&&a[Z]&&a[Z]!==n[Z]&&await ue("solicitud",{studentName:n._studentName,studentEmail:n._studentEmail,institution:n.nombre_institucion,newState:a[Z],notes:a.notas||n.notas}),R.solicitudes.update(s,a)},onSuccess:()=>{y({message:"Solicitud actualizada.",type:"success"}),E.invalidateQueries({queryKey:["adminSolicitudes",t]})},onError:s=>y({message:`Error: ${s.message}`,type:"error"})}),N=B({mutationFn:async s=>{if(t)return await L.delete("solicitudes_pps",s);await R.solicitudes.delete(s)},onSuccess:()=>{y({message:"Solicitud eliminada.",type:"success"}),E.invalidateQueries({queryKey:["adminSolicitudes",t]}),k(null)},onError:s=>{y({message:`Error: ${s.message}`,type:"error"}),k(null)}}),{activeList:m,historyList:c}=g.useMemo(()=>{if(!l)return{activeList:[],historyList:[]};const s=u.toLowerCase(),a=[],n=[],i=["finalizada","cancelada","rechazada","archivado","realizada","no se pudo concretar"];return l.forEach(b=>{if(u&&!(String(b._studentName).toLowerCase().includes(s)||String(b._studentLegajo).toLowerCase().includes(s)||(b.nombre_institucion||"").toLowerCase().includes(s)))return;const C=$(b.estado_seguimiento);j==="requieren_atencion"&&(i.includes(C)||b._daysSinceUpdate<=4)||j!=="all"&&j!=="requieren_atencion"&&$(j)!==C||(i.includes(C)?n.push(b):a.push(b))}),{activeList:a,historyList:n}},[l,u,j]);return d?e.jsx("div",{className:"flex justify-center p-12",children:e.jsx(de,{})}):p?e.jsx(W,{icon:"error",title:"Error",message:p.message}):e.jsxs("div",{className:"space-y-6",children:[v&&e.jsx(ce,{message:v.message,type:v.type,onClose:()=>y(null)}),e.jsx(xe,{isOpen:!!w,title:"¿Eliminar solicitud?",message:"Esta acción es permanente y no se puede deshacer.",confirmText:"Eliminar",type:"danger",onConfirm:()=>w&&N.mutate(w),onClose:()=>k(null)}),e.jsx(Ee,{tabs:o,activeTabId:f,onTabChange:x}),f==="egreso"?e.jsx(Pe,{isTestingMode:t}):e.jsxs("div",{className:"animate-fade-in-up space-y-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 justify-between items-center bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm",children:[e.jsxs("div",{className:"relative w-full md:w-96",children:[e.jsx("input",{type:"text",placeholder:"Buscar por alumno o institución...",value:u,onChange:s=>_(s.target.value),className:"w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-300 dark:border-slate-700 bg-slate-50 dark:bg-black/20 text-sm focus:ring-2 focus:ring-blue-500 outline-none text-slate-900 dark:text-white transition-all"}),e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 material-icons text-slate-400",children:"search"})]}),e.jsx("div",{className:"flex items-center gap-2 w-full md:w-auto",children:e.jsxs("select",{value:j,onChange:s=>S(s.target.value),className:"w-full md:w-48 py-2.5 px-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:ring-2 focus:ring-blue-500 outline-none text-slate-900 dark:text-white cursor-pointer",children:[e.jsx("option",{value:"all",children:"Estado: Todos"}),e.jsx("option",{value:"requieren_atencion",children:"⚠️ Requieren Atención"}),e.jsx("option",{value:"Pendiente",children:"Pendiente"}),e.jsx("option",{value:"En conversaciones",children:"En conversaciones"}),e.jsx("option",{value:"Realizando convenio",children:"Realizando convenio"}),e.jsx("option",{value:"Realizada",children:"Realizada"})]})})]}),e.jsxs("div",{className:"space-y-6",children:[m.length>0&&e.jsxs("div",{children:[e.jsxs("h3",{className:"text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2 pl-1",children:[e.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-blue-500"})," Pendientes de Gestión (",m.length,")"]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:m.map(s=>e.jsx(se,{req:s,onDeleteRequest:k,onUpdate:async(a,n)=>{await h.mutateAsync({recordId:a,fields:n})},isUpdatingParent:h.isPending},s.id))})]}),c.length>0&&e.jsx(me,{title:"Historial y Finalizadas",count:c.length,icon:"history",iconBgColor:"bg-slate-100 dark:bg-slate-800",iconColor:"text-slate-500 dark:text-slate-400",borderColor:"border-slate-200 dark:border-slate-800",defaultOpen:!1,children:e.jsx("div",{className:"grid grid-cols-1 gap-4 mt-4",children:c.map(s=>e.jsx(se,{req:s,onDeleteRequest:k,onUpdate:async(a,n)=>{await h.mutateAsync({recordId:a,fields:n})},isUpdatingParent:h.isPending},s.id))})}),m.length===0&&c.length===0&&e.jsx("div",{className:"py-12",children:e.jsx(W,{icon:"inbox",title:"Sin Solicitudes",message:"No se encontraron registros con los filtros actuales."})})]})]})]})};export{Me as default};
